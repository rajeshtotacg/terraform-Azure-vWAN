---
- name: Check NTP sync status on Linux servers
  hosts: all
  become: yes
  gather_facts: no

  tasks:

    - name: Ensure chrony is installed
      package:
        name: chrony
        state: present

    - name: Ensure chronyd is running
      service:
        name: chronyd
        state: started
        enabled: yes

    - name: Wait for chronyd to sync (retry 3 times)
      shell: |
        chronyc tracking | grep -q "Leap status\s*:\s*Normal"
      register: chrony_sync
      retries: 3
      delay: 10
      until: chrony_sync.rc == 0

    - name: Check if at least one NTP source is selected (^*)
      shell: |
        chronyc sources | grep -E "^\^\*"
      register: ntp_source
      failed_when: ntp_source.rc != 0
      changed_when: false

    - name: Show selected NTP source
      debug:
        msg: "{{ ntp_source.stdout_lines }}"

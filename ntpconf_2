---
- name: Check Chrony Leap status and print NTP sources
  hosts: all
  become: yes
  gather_facts: no

  tasks:

    - name: Run 'chronyc tracking' and capture Leap status
      shell: chronyc tracking | grep 'Leap status'
      register: leap_status_output
      changed_when: false

    - name: Show Leap status
      debug:
        msg: "{{ inventory_hostname }}: {{ leap_status_output.stdout }}"

    - name: Fail if Leap status is not Normal
      fail:
        msg: "Time not synchronized on {{ inventory_hostname }}! Status: {{ leap_status_output.stdout }}"
      when: "'Leap status     : Normal' not in leap_status_output.stdout"

    - name: Get NTP source names only
      shell: chronyc sources | awk 'NR>2 {print $2}'
      register: ntp_source_names
      changed_when: false

    - name: Print only NTP source names or IPs
      debug:
        msg: "{{ inventory_hostname }}: NTP sources = {{ ntp_source_names.stdout_lines }}"
